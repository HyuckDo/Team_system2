#include <stdio.h>
#include <stdlib.h>
#include <termio.h>
#include <unistd.h>
#include <curses.h>
#include <signal.h>
#include <sys/time.h>
#include <time.h>
#include <string.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <pthread.h>


#define BUF_SIZE 100
#define NAME_SIZE 20

#define MAP_X 28
#define MAP_Y 100
#define ITEM 100
void * send_msg(void * arg);
void * recv_msg(void * arg);
void recv_file(int sd);
void send_file(int sd,char* filename);
void error_handling(char * msg);
int count=0;
int top=0;
char name[NAME_SIZE]="[DEFAULT]";
char msg[BUF_SIZE];
FILE *fin;
FILE *fout;
pthread_mutex_t mutx;

int SCORE=0;
int TIME=100;
int SCORE_COUNTER=0;

char map[MAP_X][MAP_Y]={};
char map1[MAP_X][MAP_Y] ={

   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"},
   { "1000000011000000000000000000000110000000000000000000000000000000000000000000000000000000000000000001" },
   { "1000000011000000000000000000000110000000000000000000000000000000000000000000000000000000000000000001" },
   { "1000000011000000000000000000000110000000000111111111111111111111111111000000111111111111111111111111" },
   { "1000000011111111111111110000011110000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000111111110000110000000000000000000000000000000111111111111111111100001" },
   { "1000000000000000000000000000000110000000000110000000000000000000000000000000000000000000000000000001" },
   { "1000000000000000000000000000000110000000000110000000000000000000000000000000000000000000000000000001" },
   { "1000000000000000000000000000000110000000000110000000000000000000000000000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111100000000000000111111111111111111111111111111111" },
   { "1000000000000000000000000000000000000000000000000001100000000000000110000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000110000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000110000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000110000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000000000000000000000000000000000001" },
   { "1000000000000001111111111111111111100000110000000001100000000000000000000000000000000000000000000001" },
   { "1000000000000001100000000000000000000000110000000001100000000000000000000000000000000000000000000001" },
   { "1000000000000001100000000000000000000000110000000001111111111000001111111111111111111111111111111111" },
   { "1000000000000001100000000000000000000000110000000000000000000000000000000000000000000000000000000001" },
   { "1000000000000001100000000000000000000000110000000000000000000000000000000000000000000000000000000001" },
   { "1000000000000001100000000000000000000000110000000000000000000000000000000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" }

};
char map2[MAP_X][MAP_Y] ={

   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"},
   { "1000000001100000000001111111111111111111110000000001100000000000000000000000000000000000000000000001" },
   { "1000000001100000000001111111111111111111110000000001100000000000000000000000000000000000000000000001" },
   { "1000000001100000000000000000000000000000000000000001111111111111111111111111111111111111111111100001" },
   { "1000000001100000000000000000000000000000000000000001100000000000001100000000000000000000000001100001" },
   { "1000000001100000000000000000000000000000110000000001100000000000001100000000000000000000000001100001" },
   { "1000000001111111111111111111111111111111110000000001100001111111111100000000000000000000000001100001" },
   { "1000000000000000000000000000000000000000000000000001100001100000000000000000000000000000000001100001" },
   { "1000000000000000000000000000000000000000000000000001100001111111111111111111111111111111000001100001" },
   { "1111111111111111111111111111111111111111110000000001100000000000000000000000000000000000000001100001" },
   { "1000000000000011111111111111111100000000000000000001100000000000000000000000000000000000000001100001" },
   { "1000000000000000000000000000000000000000000000000001111111111111111111111111111111111111000001100001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000000000000011000000000000001100001" },
   { "1111111111111111111111111111111111111111110000000000000000000000000000000000011000000000000000000001" },
   { "1000000000000000000000000000000000000000110000000000000000000000000000000000011000000000000000000001" },
   { "1000000000000000000000000000000000000000111111111111111111111111000000000000011000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000000000000000000000000000000011000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111111100001" },
   { "1000000000111111111111111111111111111111000000000000000000000000000000000000011000000000000000000001" },
   { "1000000000110000000000000000000000000011111111111111111111111111000000000000011000000000000000000001" },
   { "1000000000110000000000000000000000000011000000000000000000000011000000000000011000000000000000000001" },
   { "1000000000110000000000000000000000000011000000000000000000000011000001111111111111110000000000000001" },
   { "1000000000110000000000001111111000000011000000000000000000000011000001100000000000110000000000000001" },
   { "1000000000110000000000001100000000000011111111111111111110000011000001100000000000110000000000000001" },
   { "1000000000110000000000001100000000000000000000000000000000000000000000000000000000000000000000000001" },
   { "1000000000110000000000001100000000000000000000000000000000000000000000000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" }

};

char map3[MAP_X][MAP_Y] ={

   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"},
   { "1000001100000000000000000000000000000000000000000000110000001100001100000000000000110000000000000001" },
   { "1000001100000000000000000000000000000000000000000000110000001100001100000000000000110000000000000001" },
   { "1000001100000011111111111111111111111111111111100000110000001100001100000000000000110000000000000001" },
   { "1000001100000011000000000000110000000000000001100000110000001100001100000000000000110000000000000001" },
   { "1000001100000011000000000000110000000000000001100000110000001100001101111111110000111111111111100001" },
   { "1000001100000011000000000000110000000000000001100000110000001100000000000000110000110000000001100001" },
   { "1000001111111111100000000000110000000000000001100000110000001100000000000000110000110000000001100001" },
   { "1000000000000000000000000000110000000000000001100000110000001111111110000000110000110000000001100001" },
   { "1000000000000000000000000000110000011111111111100000110000000000000000000000110000000000000001100001" },
   { "1111111111111111110000111111110000000000000000000000000000000000000000000000110000000000000001100001" },
   { "1000000000000000000000000000000000000000000000000000000011111111111111111111110000111111111111100001" },
   { "1000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000000001" },
   { "1000000011111111111111111111111111111111111111100000000000000000000000000000000000110000000000000001" },
   { "1000000011000011000000000000000000000011000000000000000000000000001100000000000000111111111111100001" },
   { "1000000011000011000000000000000000000011000000000000000000000000001100000000001111000000000000000001" },
   { "1111100011000011000011111111111110000011000000000000111111111111111100000000001100000000000000000001" },
   { "1000000011000011000011000000000000000011000000000000000000000000001100000000001111111111110000000001" },
   { "1000000011000011000011000000000000000011000000000000000000000000001100000000000000000000000000000001" },
   { "1000000011000000000011000000000000000000000000000000000000000000001100000000000000000000000000000001" },
   { "1000000011000000000011000000000000000000000000000000000000000000001100000000000000000000111111100001" },
   { "1111111111111111111111111111111111111111111111111111111111000000001111111111111100000000110000000001" },
   { "1000000000000110000000000001100000000000000000000000000000000000001100000000001100000000110000000001" },
   { "1000001111111110000000000001111111111111111111111111111111000000001100000000001111110000111111111111" },
   { "1000000000000000000000000000000000000000000000000000000000000000001100000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000000000000000000001100000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" }

};
char map4[MAP_X][MAP_Y] ={

 

   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"},
   { "1000000011000000000000000000110000000000000000000000000000000000000000000000000000000001100000000001" },
   { "1000000011000000000000000000110000000000000000000000000000000000000000000000000000000001100000000001" },
   { "1000000011000000000000000000110000000000000000000000000000000000000000000000000000000001100000000001" },
   { "1000000011000000001111111111110000000000000000000000000000000000000000000000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011111111111100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000011111111111111000000000000000000000001111111111111111000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011111111111000001111111111100000000000000000000001100000000000000000000000000001" },
   { "1000000011000000000000000000000000000000000000000000000000000000000001100000000000000000000000000001" },
   { "1000000011000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111" },
   { "1000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001" },
   { "1000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" }

};

void selectmap(){
	int i,j;
	int a=rand()%3;
	switch(a){
		case 0: for(i=0;i<MAP_X;i++){
				for(j=0;j<MAP_Y;j++){
						map[i][j] = map1[i][j];
				}
			}				
			break;
		case 1: for(i=0;i<MAP_X;i++){
				for(j=0;j<MAP_Y;j++){
						map[i][j] = map2[i][j];
				}
			}
			break;
		case 2: for(i=0;i<MAP_X;i++){
				for(j=0;j<MAP_Y;j++){
						map[i][j] = map3[i][j];
				}
			}
			break;
		case 3: for(i=0;i<MAP_X;i++){
				for(j=0;j<MAP_Y;j++){
						map[i][j] = map4[i][j];
				}
			}
			break;
	}
}

char cgetch(){

        struct termios oldt,newt;
        int ch;

        tcgetattr(STDIN_FILENO,&oldt);
        newt=oldt;
        newt.c_lflag&=~(ICANON|ECHO);
        tcsetattr(STDIN_FILENO,TCSANOW,&newt);
        ch=getchar();
        tcsetattr(STDIN_FILENO,TCSANOW,&oldt);
        return ch;
}


void draw() {



   int h, w;

   char temp;

   for (h = 0; h < MAP_X; h++) {

      for (w = 0; w < MAP_Y; w++) {



         temp = map[h][w];

         if (temp == '0') {

            addstr(" ");

         }

         else if (temp == '1') {

 	        addstr("#");

         }

         else if (temp == '2') {

 	        addstr("X");

         }

      }

      addstr("\n");

   }

	move(30, 40);
        addstr("SCORE: 0");   
	move(29, 40);
	addstr("TIME: ");   
	refresh();
}
int check (int x, int y){

	if(map[x][y]=='1'){
		return 1;
	}
	return 0;
}

void getscore(int x,int y){
	char buf[10];
	if(map[x][y]=='2'){
		SCORE_COUNTER++;
		SCORE=SCORE+100;
		map[x][y]='0';
		move(30, 40);
	        addstr("SCORE:                ");
		move(30, 40);
	        addstr("SCORE: ");
		sprintf(buf,"%d", SCORE);
       		addstr(buf);        
		refresh();
	}
	return;
}


void gettime(int signum){
	char buf[10];
	TIME--;
	if(TIME>-1){
	move(29, 40);
	addstr("TIME:      ");   
	move(29, 40);
	addstr("TIME: ");
	sprintf(buf,"%d", TIME);
       	addstr(buf);        
	refresh();
	}
	return;
}

int set_ticker( int n_msecs )
{
	struct itimerval new_timeset;
	long    n_sec, n_usecs;
	
	n_sec = n_msecs / 1000 ;			/* int part*/
	n_usecs = ( n_msecs % 1000 ) * 1000L ;  	/* remainder*/

	new_timeset.it_interval.tv_sec  = n_sec;        /* set reload       */
	new_timeset.it_interval.tv_usec = n_usecs;      /* new ticker value */
	new_timeset.it_value.tv_sec     = n_sec  ;      /* store this       */
	new_timeset.it_value.tv_usec    = n_usecs ;     /* and this         */

	return setitimer(ITIMER_REAL, &new_timeset, NULL);
}


void makescore(){
	int i;
	int a,b;
	for(i=0;i<ITEM;i++){
	a=rand()%MAP_X;
	b=rand()%MAP_Y;
		if(map[a][b]=='0'){
			map[a][b]='2';
		}
		else i--;
	}

	return;
}



int main(int argc,char* argv[]){

	int a,b,c;
	int x, y;
	int ax,ay;
	char buf[10];
	x=25;
	y=1;
	ax=x;
	ay=y;
	srand(time(NULL));
	selectmap();
	
	int num;
	int sock;
        struct sockaddr_in serv_addr;
	 pthread_t snd_thread, rcv_thread,frcv_thread;
        void * thread_return;

        if(argc!=4) {
                printf("Usage : %s <IP> <port> <name>\n", argv[0]);
                exit(1);
         }

        sprintf(name, "[%s]", argv[3]);
        sock=socket(PF_INET, SOCK_STREAM, 0);

        memset(&serv_addr, 0, sizeof(serv_addr));
        serv_addr.sin_family=AF_INET;
        serv_addr.sin_addr.s_addr=inet_addr(argv[1]);
        serv_addr.sin_port=htons(atoi(argv[2]));


        if(connect(sock, (struct sockaddr*)&serv_addr, sizeof(serv_addr))==-1)
                error_handling("connect() error");
	
	while(1){
	
                printf("======= Game World ========\n");
		printf("1.Game Start\n");
		printf("2.Explain Game\n");
		printf("3.Enter the Chat-Room\n");
		printf("4.Exit Game\n");
		printf("===========================\n");
		
                num=cgetch()-48;
		
                switch(num){

                case 1:{ 

initscr();
clear();
makescore();
draw();
signal (SIGALRM, gettime);
set_ticker(1000);

 for(int i=1;i;i++){
	if(TIME<0)
		break;
	if(SCORE_COUNTER>=ITEM){
		TIME=0;		
		break;	
	}
         a=cgetch();
	 if(a=='q'||a=='Q'){
		 TIME=0;
		 break;
	 }
         b=cgetch();
         c=cgetch();
 switch(c){
	 case 67:{
		y++;
		if(check(x,y)){
			y--;
		SCORE=SCORE-50;
		move(30, 40);
	        addstr("SCORE:                ");
		move(30, 40);
	        addstr("SCORE: ");
		sprintf(buf,"%d", SCORE);
       		addstr(buf);        
		refresh();
		break;
		}
         	move(ax,ay);
        	addstr(" ");
		getscore(x,y);
         	move(x,y);
		ax=x;
		ay=y;
         	addstr("O");
         	refresh();
		 break;
        	 }
 	case 68:{
		y--;
		if(check(x,y)){
			y++;
		SCORE=SCORE-50;
		move(30, 40);
	        addstr("SCORE:                ");
		move(30, 40);
	        addstr("SCORE: ");
		sprintf(buf,"%d", SCORE);
       		addstr(buf);        
		refresh();
			break;
		}
		
         	move(ax,ay);
        	addstr(" ");
		getscore(x,y);
         	move(x,y);
		ax=x;
		ay=y;
         	addstr("O");
         	refresh();
		 break;
                }
	 case 65:{
		x--;
		if(check(x,y)){
			x++;
		SCORE=SCORE-50;
		move(30, 40);
	        addstr("SCORE:                ");
		move(30, 40);
	        addstr("SCORE: ");
		sprintf(buf,"%d", SCORE);
       		addstr(buf);        
		refresh();
			break;
		}
		
         	move(ax,ay);
        	addstr(" ");
		getscore(x,y);
         	move(x,y);
		ax=x;
		ay=y;
         	addstr("O");
         	refresh();
		 break;
                }
	case 66:{
		x++;
		if(check(x,y)){
			x--;
		SCORE=SCORE-50;
		move(30, 40);
	        addstr("SCORE:                ");
		move(30, 40);
	        addstr("SCORE: ");
		sprintf(buf,"%d", SCORE);
       		addstr(buf);        
		refresh();
			break;
		}
		
         	move(ax,ay);
        	addstr(" ");
		getscore(x,y);
         	move(x,y);
		ax=x;
		ay=y;
         	addstr("O");
         	refresh();
		 break;
		 }
	}
 }

clear();
move(20, 40);
addstr("SCORE: ");
sprintf(buf,"%d", SCORE);
addstr(buf);    
move(21, 40);
addstr("Want quit? please press 'q'");
refresh();
for(int i=1;i;i++){	
         a=cgetch();
	if(a=='q')
		break;
}


endwin();




			}
		case 2: 
			printf("1. move key is arrow key\n"); 
			printf("2. move 'O' and if you get 'X' you get 100 score\n"); 
			printf("3. if you hit '#' score -50 \n");
			printf("4. if you get all 'X' or time out game over \n");
			break;
		case 3:
			pthread_create(&snd_thread, NULL, send_msg, (void*)&sock);//쓰레드 생성
        		pthread_create(&rcv_thread, NULL, recv_msg, (void*)&sock);

        		pthread_join(snd_thread, &thread_return);//쓰레드 도중 종료 방지
	        	pthread_join(rcv_thread, &thread_return);
			break;

		case 4: 
			exit(1);
			break;
		
	}
}
	close(sock);
	return 0;
}
void * send_msg(void * arg)   // send thread main
{
        int sock=*((int*)arg);
        char name_msg[NAME_SIZE+BUF_SIZE];
        char close_msg[BUF_SIZE];
        char in_msg[BUF_SIZE];
        char filename[BUF_SIZE];
        strcpy(filename,name);
        strcat(filename,".txt");
        fin=fopen(filename,"r");
        fout=fopen(filename,"a");
        sprintf(close_msg,"%s님이 채팅방을 나가셨습니다.\n",name);
        sprintf(in_msg,"%s님이 채팅방에 입장하셨습니다.\n",name);
        write(sock,in_msg,strlen(in_msg));

        while(1)
        {

                fgets(msg, BUF_SIZE, stdin);

                if(!strcmp(msg,"q\n")||!strcmp(msg,"Q\n"))
                {
                        write(sock,close_msg,strlen(close_msg));
                        fprintf(fout,"%s\n",close_msg);
                        close(sock);
                        return 0;
                }

                if(strcmp(msg,"file_send\n")==0){       //file_send키워드를 입력            
                        strcpy(name_msg,"file_send");
                }
                else
                        sprintf(name_msg,"%s %s", name, msg);   //일반 채팅시   

                write(sock, name_msg, strlen(name_msg));



        }
        return NULL;
}
void * recv_msg(void * arg)   // read thread main
{
        int sock=*((int*)arg);
        char name_msg[NAME_SIZE+BUF_SIZE];
        int str_len;
        while(1)
        {
                str_len=read(sock, name_msg, NAME_SIZE+BUF_SIZE-1);              
                if(str_len==-1)
                        return (void*)-1;

                name_msg[str_len]=0;

                if(strncmp(name_msg,"file_sending",strlen("file_sending"))==0){//서버가 파일전송신호를 보낼때                   
                        recv_file(sock);
                }
                else{
                        fputs(name_msg, stdout);
                        fprintf(fout,"%s\n",name_msg);//대화기록 저장
                }

        }

        return NULL;
}

void recv_file(int sd){


        int filesize=0;
        int bufsize;
        int nbyte=0;
        int BUFSIZE=40;
        int cnt=0;
        int sum=0;
        char buf[BUFSIZE];
        char filename[20];
        strcpy(filename,name);
        strcat(filename,".png");
        FILE *file=fopen(filename,"wb");
        char temp_char;
        long temp_long=0;
        long n;



        recv(sd,&filesize,sizeof(filesize),0);


        bufsize=BUFSIZE;//서버와 동일
        while(filesize!=0){
                if(filesize<BUFSIZE)
                        bufsize=filesize;
                nbyte=recv(sd,buf,bufsize,0);
                filesize=filesize-nbyte;
                fwrite(buf,sizeof(char),nbyte,file);
                nbyte=0;
        }
        printf("파일 전송 완료\n");
        fclose(file);
        return;
}
void send_file(int sd,char* filename){

        int fsize=0;
        int nsize=0;
        int fpsize=0;
        int BUFSIZE=20;
        char buf[BUFSIZE];

        FILE *file=fopen(filename,"rb");//서버와 동일
        fseek(file,0,SEEK_END);
        fsize=ftell(file);
        fseek(file,0,SEEK_SET);
        send(sd,&fsize,sizeof(fsize),0);
        while(nsize!=fsize){
                fpsize=fread(buf,1,BUFSIZE,file);
                nsize=nsize+fpsize;
                send(sd,buf,fpsize,0);
        }
        fclose(file);

}
void error_handling(char *msg)
{
        fputs(msg, stderr);
        fputc('\n', stderr);
        exit(1);
}


#include <stdio.h>
#include <stdlib.h>
#include <termio.h>
#include <unistd.h>
#include <curses.h>
#include <signal.h>
#include <sys/time.h>
#include <time.h>
#include <string.h>

#define MAP_X 28
#define MAP_Y 100
#define ITEM 100

int SCORE=0;
int TIME=200;

char map[MAP_X][MAP_Y]={};
char map1[MAP_X][MAP_Y] ={

   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"},
   { "1000000011000000000000000000000110000000000000000000000000000000000000000000000000000000000000000001" },
   { "1000000011000000000000000000000110000000000000000000000000000000000000000000000000000000000000000001" },
   { "1000000011000000000000000000000110000000000111111111111111111111111111000000111111111111111111111111" },
   { "1000000011111111111111110000011110000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000000000000000110000000000000000000000000000000110000000000000000000001" },
   { "1000000000000000000000000000000111111110000110000000000000000000000000000000111111111111111111100001" },
   { "1000000000000000000000000000000110000000000110000000000000000000000000000000000000000000000000000001" },
   { "1000000000000000000000000000000110000000000110000000000000000000000000000000000000000000000000000001" },
   { "1000000000000000000000000000000110000000000110000000000000000000000000000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111100000000000000111111111111111111111111111111111" },
   { "1000000000000000000000000000000000000000000000000001100000000000000110000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000110000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000110000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000110000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000000000000000000000000000000000001" },
   { "1000000000000001111111111111111111100000110000000001100000000000000000000000000000000000000000000001" },
   { "1000000000000001100000000000000000000000110000000001100000000000000000000000000000000000000000000001" },
   { "1000000000000001100000000000000000000000110000000001111111111000001111111111111111111111111111111111" },
   { "1000000000000001100000000000000000000000110000000000000000000000000000000000000000000000000000000001" },
   { "1000000000000001100000000000000000000000110000000000000000000000000000000000000000000000000000000001" },
   { "1000000000000001100000000000000000000000110000000000000000000000000000000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" }

};
char map2[MAP_X][MAP_Y] ={

   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"},
   { "1000000001100000000001111111111111111111110000000001100000000000000000000000000000000000000000000001" },
   { "1000000001100000000001111111111111111111110000000001100000000000000000000000000000000000000000000001" },
   { "1000000001100000000000000000000000000000000000000001111111111111111111111111111111111111111111100001" },
   { "1000000001100000000000000000000000000000000000000001100000000000001100000000000000000000000001100001" },
   { "1000000001100000000000000000000000000000110000000001100000000000001100000000000000000000000001100001" },
   { "1000000001111111111111111111111111111111110000000001100001111111111100000000000000000000000001100001" },
   { "1000000000000000000000000000000000000000000000000001100001100000000000000000000000000000000001100001" },
   { "1000000000000000000000000000000000000000000000000001100001111111111111111111111111111111000001100001" },
   { "1111111111111111111111111111111111111111110000000001100000000000000000000000000000000000000001100001" },
   { "1000000000000011111111111111111100000000000000000001100000000000000000000000000000000000000001100001" },
   { "1000000000000000000000000000000000000000000000000001111111111111111111111111111111111111000001100001" },
   { "1000000000000000000000000000000000000000000000000001100000000000000000000000011000000000000001100001" },
   { "1111111111111111111111111111111111111111110000000000000000000000000000000000011000000000000000000001" },
   { "1000000000000000000000000000000000000000110000000000000000000000000000000000011000000000000000000001" },
   { "1000000000000000000000000000000000000000111111111111111111111111000000000000011000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000000000000000000000000000000011000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111111100001" },
   { "1000000000111111111111111111111111111111000000000000000000000000000000000000011000000000000000000001" },
   { "1000000000110000000000000000000000000011111111111111111111111111000000000000011000000000000000000001" },
   { "1000000000110000000000000000000000000011000000000000000000000011000000000000011000000000000000000001" },
   { "1000000000110000000000000000000000000011000000000000000000000011000001111111111111110000000000000001" },
   { "1000000000110000000000001111111000000011000000000000000000000011000001100000000000110000000000000001" },
   { "1000000000110000000000001100000000000011111111111111111110000011000001100000000000110000000000000001" },
   { "1000000000110000000000001100000000000000000000000000000000000000000000000000000000000000000000000001" },
   { "1000000000110000000000001100000000000000000000000000000000000000000000000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" }

};

char map3[MAP_X][MAP_Y] ={

   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"},
   { "1000001100000000000000000000000000000000000000000000110000001100001100000000000000110000000000000001" },
   { "1000001100000000000000000000000000000000000000000000110000001100001100000000000000110000000000000001" },
   { "1000001100000011111111111111111111111111111111100000110000001100001100000000000000110000000000000001" },
   { "1000001100000011000000000000110000000000000001100000110000001100001100000000000000110000000000000001" },
   { "1000001100000011000000000000110000000000000001100000110000001100001101111111110000111111111111100001" },
   { "1000001100000011000000000000110000000000000001100000110000001100000000000000110000110000000001100001" },
   { "1000001111111111100000000000110000000000000001100000110000001100000000000000110000110000000001100001" },
   { "1000000000000000000000000000110000000000000001100000110000001111111110000000110000110000000001100001" },
   { "1000000000000000000000000000110000011111111111100000110000000000000000000000110000000000000001100001" },
   { "1111111111111111110000111111110000000000000000000000000000000000000000000000110000000000000001100001" },
   { "1000000000000000000000000000000000000000000000000000000011111111111111111111110000111111111111100001" },
   { "1000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000000001" },
   { "1000000011111111111111111111111111111111111111100000000000000000000000000000000000110000000000000001" },
   { "1000000011000011000000000000000000000011000000000000000000000000001100000000000000111111111111100001" },
   { "1000000011000011000000000000000000000011000000000000000000000000001100000000001111000000000000000001" },
   { "1111100011000011000011111111111110000011000000000000111111111111111100000000001100000000000000000001" },
   { "1000000011000011000011000000000000000011000000000000000000000000001100000000001111111111110000000001" },
   { "1000000011000011000011000000000000000011000000000000000000000000001100000000000000000000000000000001" },
   { "1000000011000000000011000000000000000000000000000000000000000000001100000000000000000000000000000001" },
   { "1000000011000000000011000000000000000000000000000000000000000000001100000000000000000000111111100001" },
   { "1111111111111111111111111111111111111111111111111111111111000000001111111111111100000000110000000001" },
   { "1000000000000110000000000001100000000000000000000000000000000000001100000000001100000000110000000001" },
   { "1000001111111110000000000001111111111111111111111111111111000000001100000000001111110000111111111111" },
   { "1000000000000000000000000000000000000000000000000000000000000000001100000000000000000000000000000001" },
   { "1000000000000000000000000000000000000000000000000000000000000000001100000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" }

};
char map4[MAP_X][MAP_Y] ={

 

   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"},
   { "1000000011000000000000000000110000000000000000000000000000000000000000000000000000000001100000000001" },
   { "1000000011000000000000000000110000000000000000000000000000000000000000000000000000000001100000000001" },
   { "1000000011000000000000000000110000000000000000000000000000000000000000000000000000000001100000000001" },
   { "1000000011000000001111111111110000000000000000000000000000000000000000000000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011111111111100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000000000000000000000000000000000000000000000000000000011000000001100000000000000001100000000001" },
   { "1000000011111111111111000000000000000000000001111111111111111000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011000000000000000000000001100000000000000000000001100000000000000001100000000001" },
   { "1000000011000000000011111111111000001111111111100000000000000000000001100000000000000000000000000001" },
   { "1000000011000000000000000000000000000000000000000000000000000000000001100000000000000000000000000001" },
   { "1000000011000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111" },
   { "1000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001" },
   { "1000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001" },
   { "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111" }

};

void selectmap(){
	int i,j;
	int a=rand()%3;
	switch(a){
		case 0: for(i=0;i<MAP_X;i++){
				for(j=0;j<MAP_Y;j++){
						map[i][j] = map1[i][j];
				}
			}				
			break;
		case 1: for(i=0;i<MAP_X;i++){
				for(j=0;j<MAP_Y;j++){
						map[i][j] = map2[i][j];
				}
			}
			break;
		case 2: for(i=0;i<MAP_X;i++){
				for(j=0;j<MAP_Y;j++){
						map[i][j] = map3[i][j];
				}
			}
			break;
		case 3: for(i=0;i<MAP_X;i++){
				for(j=0;j<MAP_Y;j++){
						map[i][j] = map4[i][j];
				}
			}
			break;
	}
}

char cgetch(){

        struct termios oldt,newt;
        int ch;

        tcgetattr(STDIN_FILENO,&oldt);
        newt=oldt;
        newt.c_lflag&=~(ICANON|ECHO);
        tcsetattr(STDIN_FILENO,TCSANOW,&newt);
        ch=getchar();
        tcsetattr(STDIN_FILENO,TCSANOW,&oldt);
        return ch;
}


void draw() {



   int h, w;

   char temp;

   for (h = 0; h < MAP_X; h++) {

      for (w = 0; w < MAP_Y; w++) {



         temp = map[h][w];

         if (temp == '0') {

            addstr(" ");

         }

         else if (temp == '1') {

 	        addstr("#");

         }

         else if (temp == '2') {

 	        addstr("X");

         }

      }

      addstr("\n");

   }

	move(30, 40);
        addstr("SCORE: 0");   
	move(29, 40);
	addstr("TIME: ");   
	refresh();
}
int check (int x, int y){

	if(map[x][y]=='1'){
		return 1;
	}
	return 0;
}

void getscore(int x,int y){
	char buf[10];
	if(map[x][y]=='2'){
		SCORE=SCORE+100;
		map[x][y]='0';
		move(30, 40);
	        addstr("SCORE:                ");
		move(30, 40);
	        addstr("SCORE: ");
		sprintf(buf,"%d", SCORE);
       		addstr(buf);        
		refresh();
	}
	return;
}


void gettime(int signum){
	char buf[10];
	TIME--;
	if(TIME>-1){
	move(29, 40);
	addstr("TIME:      ");   
	move(29, 40);
	addstr("TIME: ");
	sprintf(buf,"%d", TIME);
       	addstr(buf);        
	refresh();
	}
	return;
}

int set_ticker( int n_msecs )
{
	struct itimerval new_timeset;
	long    n_sec, n_usecs;
	
	n_sec = n_msecs / 1000 ;			/* int part*/
	n_usecs = ( n_msecs % 1000 ) * 1000L ;  	/* remainder*/

	new_timeset.it_interval.tv_sec  = n_sec;        /* set reload       */
	new_timeset.it_interval.tv_usec = n_usecs;      /* new ticker value */
	new_timeset.it_value.tv_sec     = n_sec  ;      /* store this       */
	new_timeset.it_value.tv_usec    = n_usecs ;     /* and this         */

	return setitimer(ITIMER_REAL, &new_timeset, NULL);
}


void makescore(){
	int i;
	int a,b;
	for(i=0;i<ITEM;i++){
	a=rand()%MAP_X;
	b=rand()%MAP_Y;
		if(map[a][b]=='0'){
			map[a][b]='2';
		}
		else i--;
	}

	return;
}



int main(void){

	int a,b,c;
	int x, y;
	int ax,ay;
	char buf[10];
	x=25;
	y=1;
	ax=x;
	ay=y;
	srand(time(NULL));
	selectmap();
	
	initscr();
	clear();
	makescore();
	draw();
	signal (SIGALRM, gettime);
	set_ticker(500);
	
	int num;


        while(1){


                printf("======= Game World ========\n");
                printf("1.Game Start\n");
                printf("2.Explain Game\n");
                printf("===========================\n");

                scanf("%d", &num);

                switch(num){

                        case 1:{ 
				x=25;
        			y=1;
     				ax=x;
        			ay=y;
   			    	srand(time(NULL));
        			selectmap();

       				initscr();
        			clear();
        			makescore();
        			draw();
        			signal (SIGALRM, gettime);
        			set_ticker(500);

        		


				for(int i=1;i;i++){
					if(TIME<0)
						break;	
  	     			a=cgetch();
        			b=cgetch();
        			c=cgetch();
 				switch(c){
				case 67:{
					y++;
					if(check(x,y)){
						y--;
					SCORE=SCORE-50;
					move(30, 40);
	        			addstr("SCORE:                ");
					move(30, 40);
	        			addstr("SCORE: ");
					sprintf(buf,"%d", SCORE);
       					addstr(buf);        
					refresh();
					break;
					}
         				move(ax,ay);
        				addstr(" ");
					getscore(x,y);
         				move(x,y);
					ax=x;
					ay=y;
         				addstr("O");
         				refresh();
					break;
        				}
 				case 68:{
					y--;
					if(check(x,y)){
						y++;
					SCORE=SCORE-50;
					move(30, 40);
			        	addstr("SCORE:                ");
					move(30, 40);
	        			addstr("SCORE: ");
					sprintf(buf,"%d", SCORE);
		       			addstr(buf);        
					refresh();
					break;
					}
			
         				move(ax,ay);
        				addstr(" ");
					getscore(x,y);
         				move(x,y);
					ax=x;
					ay=y;
         				addstr("O");
         				refresh();
					break;
                		}
	 			case 65:{
					x--;
					if(check(x,y)){
						x++;
					SCORE=SCORE-50;
					move(30, 40);
	        			addstr("SCORE:                ");
					move(30, 40);
	        			addstr("SCORE: ");
					sprintf(buf,"%d", SCORE);
       					addstr(buf);        
					refresh();
					break;
					}
			
         				move(ax,ay);
        				addstr(" ");
					getscore(x,y);
         				move(x,y);
					ax=x;
					ay=y;
         				addstr("O");
         				refresh();
					break;
                		}
				case 66:{
					x++;
					if(check(x,y)){
						x--;
					SCORE=SCORE-50;
					move(30, 40);
	        			addstr("SCORE:                ");
					move(30, 40);
	        			addstr("SCORE: ");
					sprintf(buf,"%d", SCORE);
       					addstr(buf);        
					refresh();
					break;
					}
				
         				move(ax,ay);
        				addstr(" ");
					getscore(x,y);
         				move(x,y);
					ax=x;
					ay=y;
         				addstr("O");
         				refresh();
					break;
				 	}
			}	
			

			clear();
			move(20, 40);
			addstr("SCORE: ");
			sprintf(buf,"%d", SCORE);
			addstr(buf);    
			move(21, 40);
			addstr("Want quit? please press 'q'");
			refresh();
			for(int i=1;i;i++){	
        			a=cgetch();
				if(a=='q')
					break;
			}	


			endwin();
			break;

		}
		case 2: 
			printf("2");
			break;
	}

	return 0;
}
